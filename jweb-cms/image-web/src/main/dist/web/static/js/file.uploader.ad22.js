window.Uploader={panel:$(".sited-file-uploader"),fileList:$(".sited-file-uploader__table-body"),loadingBar:$(".sited-file-uploader__row-progress"),failMessage:$(".sited-file-uploader__message-inner-fail"),successMessage:$(".sited-file-uploader__message--success"),fileQueue:[],isUploadHold:!1,running:!1,path:"test",uploadingNumber:$("#uploading_number"),uploadedNumber:$("#uploaded_number"),failedNumber:$(".failed_number"),successNumber:$(".success_number"),init:function(){$(document).on("change",".sited-file-upload-handler",function(e){var i=e.target.files;i&&i[0]&&(this.addQueue(i),this.renderNodes(),this.startUpload())}.bind(this)),$(".sited-file-uploader__toggle").click(function(){this.expand()}.bind(this)),$(".sited-file-uploader__close").click(function(){this.hide()}.bind(this))},startUpload:function(){this.show(),this.running||this.fileQueue.length>0&&!this.isUploadHold&&(this.running=!0,this.successMessage.removeClass("show"),this.failMessage.removeClass("show"),this.upload(this.nextFile()))},nextFile:function(){for(var e=0;e<this.fileQueue.length;e+=1)if(!this.fileQueue[e].uploaded)return this.fileQueue[e];this.finishUpload()},finishUpload:function(){this.running=!1;for(var e=0,i=0,s=0;s<this.fileQueue.length;s+=1)"success"===this.fileQueue[s].status?e+=1:i+=1;this.failedNumber.text(i),this.successNumber.text(e),i>0?this.failMessage.addClass("show"):this.successMessage.addClass("show"),e>0&&window.location.reload()},upload:function(e){if(e){var i=new FormData;i.append("file",e.file),$.ajax({type:"POST",url:"/web/api/file/upload?directoryId="+$("#directoryId").val(),contentType:!1,accept:"application/json",processData:!1,data:i,xhr:function(){var i=new window.XMLHttpRequest;return i.upload.addEventListener("progress",function(i){if(i.lengthComputable){var s=i.loaded/i.total*100;Uploader.progress(s,e)}},!1),i.addEventListener("progress",function(e){},!1),i},success:function(i){e.status="success",Uploader.finish(e),Uploader.upload(Uploader.nextFile())},error:function(i){e.status="error",Uploader.finish(e),Uploader.upload(Uploader.nextFile())}})}},progress:function(e,i){this.loadingBar.fadeIn(),this.loadingBar.css("top",44*i.index+"px"),this.loadingBar.css("width",e+"%"),$("#uploading-index-"+i.index).find(".sited-file-uploader__status").text(e+"%")},finish:function(e){e.uploaded=!0;var i=$("#uploading-index-"+e.index),s=i.find(".sited-file-uploader__status");"success"===e.status?s.html("<i class='iconfont icon-zhengque'>"):s.html("<i class='iconfont icon-tishi'>"),this.loadingBar.fadeOut(function(){this.loadingBar.css("width",0)}.bind(this)),this.uploadedNumber.text(this.calcUploadedNumber())},calcUploadingNumber:function(){for(var e=0,i=0;i<this.fileQueue.length;i+=1)this.fileQueue[i].uploaded||(e+=1);return e},calcUploadedNumber:function(){for(var e=0,i=0;i<this.fileQueue.length;i+=1)this.fileQueue[i].uploaded&&(e+=1);return e},renderNodes:function(){this.fileQueue.forEach(function(e){e.rendered||this.renderNode(e)}.bind(this))},renderNode:function(e){var i=$("<tr class='sited-file-uploader__row' id='uploading-index-"+e.index+"'></tr>");i.append("<td class='sited-file-uploader__col' style='width:210px;'>"+e.file.name+"</td>"),i.append("<td class='sited-file-uploader__col' style='width:100px;text-align: center'>"+e.file.size+"</td>"),i.append("<td class='sited-file-uploader__col' style='width:100px;'>"+this.path+"</td>"),i.append("<td class='sited-file-uploader__col' style='width:50px;'><div class='sited-file-uploader__status'></div></td>"),this.fileList.append(i),e.rendered=!0},addQueue:function(e){this.holdUpload();for(var i=0;i<e.length;i+=1)this.fileQueue.push({index:this.fileQueue.length,file:e[i],rendered:!1,uploaded:!1});this.uploadingNumber.text(this.calcUploadingNumber()),this.unHoldUpload()},holdUpload:function(){this.isUploadHold=!0},unHoldUpload:function(){this.isUploadHold=!1},show:function(){this.panel.addClass("show"),this.expand()},hide:function(){this.panel.removeClass("show")},expand:function(){this.panel.addClass("expand")},fold:function(){this.panel.removeClass("expand")}},Uploader.init();
function parentHtml(t){var e=t.children,n=$(parentTemplate);t.comment.user.imageURL&&n.find(".comment-author-avatar").html("<img src='"+t.comment.user.imageURL+'\' alt="">'),n.find(".comment-author-name").text(t.comment.user.username),n.find(".comment-author-date>span").text(dateString(t.comment.createdTime)),n.find(".comment-content-text>span").text(t.comment.content),n.find(".comment-reply-btn").data("id",t.comment.id);for(var i=$("<ul></ul>"),o=0;o<t.children.items.length;o++){var a=e.items[o];i.append(replyHtml(a))}if(t.remainNum>0){var r=$(moreTemplate);r.find(".comment-more__count").test(t.remainNum),r.data("first-parent-id",t.comment.id),r.data("page",t.children.page),i.append(r)}return n.find(".comment-reply").html(i),n}function replyHtml(t){var e=$(childTemplate);return t.user.imageURL&&e.find(".comment-author-avatar").html("<img src='"+t.user.imageURL+'\' alt="">'),e.find(".comment-author-name>span").text(t.user.nickname),e.find(".comment-author-date>span").text(dateString(t.comment.createdTime)),e.find(".comment-content-text>span").text(t.comment.content),e.find(".comment-reply-btn").data("id",t.comment.id),e.find(".user-comment-text").data("id",t.comment.id),e}function dateString(t){var t=new Date(t);return t.getFullYear()+"-"+(t.getMonth()<9?"0":"")+(t.getMonth()+1)+"-"+(t.getDate()<9?"0":"")+t.getDate()+" "+(t.getHours()<9?"0":"")+t.getHours()+":"+(t.getHours()<9?"0":"")+t.getMinutes()+":"+(t.getHours()<9?"0":"")+t.getSeconds()}function setCookie(t,e,n){var i=(new Date).getTime()+1e3*n;document.cookie=t+"="+decodeURI(e)+(null==n?"":";expires="+new Date(i).toGMTString())}$.prototype.serializeToObject=function(){for(var t=$(this).serializeArray(),e={},n=0;n<t.length;n+=1){var i=t[n];e[i.name]=i.value}return e},$.prototype.invalidFields=function(t){for(var e=0;e<t.length;e+=1)this.invalid(t[e].path)},$.prototype.invalid=function(t){var e=$(this).find("[name='"+t+"']");e.addClass("error"),e.change(function(){e.removeClass("error"),e.off("change")})},$.prototype.transInClass=function(t){this.css("animation","transformIcon 0.4s linear"),setTimeout(function(){this.addClass(t)}.bind(this),200),setTimeout(function(){this.css("animation","")}.bind(this),450)},$.prototype.transOutClass=function(t){this.css("animation","transformIconBack 0.4s linear"),setTimeout(function(){this.removeClass(t)}.bind(this),200),setTimeout(function(){this.css("animation","")}.bind(this),450)},$(function(){Comment.init()});var pageId=$("#pageId").val(),parentTemplate=$("#template-parent").html(),childTemplate=$("#template-child").html(),moreTemplate=$("#template-more").html();Comment={$form:$(".user-comment-form"),$container:$(".comment-list"),forbidden:$(".user-comment__forbidden"),loginButton:$(".user-comment-login"),init:function(){this.$container.on("click",".user-comment-submit",function(t){this.submit($(t.currentTarget))}.bind(this)),this.$container.on("click",".comment-more-btn",function(t){this.more($(t.currentTarget))}.bind(this)),this.$container.on("click",".comment-reply-btn",function(t){if("false"===$("#allow").val())return void(window.location.href="/login");this.reply($(t.currentTarget))}.bind(this)),this.$container.on("click",".comment-vote-btn",function(t){this.vote($(t.currentTarget))}.bind(this)),this.$container.on("click",".reply-cancel",function(t){$(t.currentTarget).parents(".reply-content").hide()}),this.$container.on("click",".reply-submit",function(t){this.submit($(t.currentTarget))}.bind(this)),this.loginButton.on("click",function(t){setCookie("_from_url",window.location.href,3600),window.location.href="/user/login"}.bind(this)),$.ajax({url:"/web/api/user/user-info",method:"GET",dataType:"json"}).then(function(t){const e=$(".user-comment-text").attr("visitorCommentEnabled");t.authenticated||"false"!==e||($(".user-comment-text").prop("disabled",!0),$(".user-comment-submit").hide(),$(".comment-reply-btn").hide(),$(".user-comment-login-button").show())}).fail(function(){alert("Load user info failed")})},submit:function(t){var e=t.siblings(".user-comment-text"),n={parentId:e.data("id"),content:e.val(),pageId:pageId};$.ajax({url:"/web/api/comment",method:"POST",data:JSON.stringify(n),contentType:"application/json",dataType:"json"}).then(function(n){t.parents(".reply-content").hide();var i=replyHtml(n);if(n.comment.parentId){t.parents(".comment-content").find(">.comment-reply>ul").prepend(i);var o=t.parent().siblings(".comment-btn-group").find(".comment-total-replies"),a=o.html(),r=parseInt(a.substring(1,a.length-1))+1;o.html("("+r+")")}else $(".comment-list__list").prepend(i);e.val("")}.bind(this)).fail(function(t){if(401===t.status)window.location.href="/login";else if(403===t.status){var e=this.forbidden;e.slideDown(),setTimeout(function(){e.fadeOut(2e3)},3e3)}}.bind(this))},reply:function(t){var e=t.parent().siblings(".reply-content");e.find("textarea").val(""),e.show()},vote:function(t){var e=t.data("id");$.ajax({url:"/web/api/comment/"+e+"/vote",method:"POST",dataType:"json"}).then(function(e){t.find(".comment-vote-up").html("("+e.totalVoteUp+")")}.bind(this))},more:function(t){var e={firstParentId:t.data("firstParentId"),page:t.data("page")+1};$.ajax({url:"/web/api/comment/page/"+pageId,method:"PUT",data:JSON.stringify(e),contentType:"application/json",dataType:"json"}).then(function(e){for(var n=e.total-((e.page-1)*e.limit+e.items.length),i=t.parent("li"),o="",a=0;a<e.items.length;a++){var r=e.items[a],m=r.comment;m.parentId?o+=replyHtml(m):o+=parentHtml(r)}i.before(o),n<=0?i.remove():t.find("span").html(n),t.data("page",e.page)}).fail(function(){alert("Load failed")})}};